<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Article IP IOC Extractor version 219</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 20px; color:#111 }
  h1 { margin-top: 0 }
  .container { max-width: 900px; margin: 0 auto; }
  label { display:block; margin:10px 0 6px; font-weight:600 }
  input[type="text"], textarea, select { width:100%; box-sizing:border-box; padding:8px; font-size:14px; border:1px solid #ccc; border-radius:6px }
  textarea { min-height:180px; font-family: monospace; white-space: pre; }
  button { margin-top:10px; padding:10px 14px; font-weight:600; border-radius:8px; border:1px solid #2b6cb0; background:#2b6cb0; color:white; cursor:pointer }
  button.secondary { background: #eee; color:#111; border-color:#aaa }
  .row { display:flex; gap:8px; margin-top:8px }
  .row > * { flex:1 }
  .results { margin-top:16px }
  .ipcard { border:1px solid #e3e3e3; padding:10px; border-radius:8px; margin-bottom:8px; background:#fbfbfd }
  .meta { color:#666; font-size:13px; margin-bottom:6px }
  .context { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; background:#f5f7fb; padding:8px; border-radius:6px; white-space:pre-wrap; overflow:auto; max-height:140px }
  .small { font-size:13px; color:#555 }
  .note { background:#fff8c6; padding:10px; border-radius:8px; margin-top:10px; border:1px solid #f1e28a; }
  footer { margin-top:18px; font-size:13px; color:#666 }
  .flex-between { display:flex; justify-content:space-between; align-items:center; gap:10px }
  .copy-btn { margin-left:8px; padding:6px 10px; border-radius:6px; border:1px solid #888; background:#fff; color:#111; cursor:pointer }
  .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center }
  .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; background:#fff; font-family:monospace; }
  #all-ips { min-height: 90px; }
</style>
</head>
<body>
  <div class="container">
    <h1>Article IP IOC Extractor</h1>
    <p class="small">Paste a URL to fetch an article and extract IPv4 IOCs (handles defanging like <code>1[.]2[.]3[.]4</code>, <code>dot</code>, <code>(.)</code>, etc.).</p>

    <label for="url">Article URL</label>
    <input id="url" type="text" inputmode="url" placeholder="https://example.com/news/article.html" />

    <div class="row">
      <button id="fetchBtn" type="button">Fetch &amp; Extract</button>
      <button id="pasteBtn" type="button" class="secondary">Paste article HTML/text instead</button>
    </div>

    <label for="useProxies" style="margin-top:12px">
      <input id="useProxies" type="checkbox" checked /> Use CORS proxies if direct fetch fails
    </label>
    <div class="note">
      <strong>Proxy fallback:</strong> uses public proxies if direct fetch fails. For reliability, host your own tiny proxy.
    </div>

    <label for="manualText">Article HTML / Text (optional ‚Äî paste if fetch fails)</label>
    <textarea id="manualText" placeholder="Paste article HTML or plain text here (you can paste the whole page)."></textarea>

    <div class="row">
      <button id="extractFromText" type="button">Extract from Pasted Text</button>
      <button id="clearBtn" type="button" class="secondary">Clear</button>
    </div>

    <div class="results">
      <div class="flex-between">
        <h2 id="resultsTitle">Results</h2>
        <div class="toolbar">
          <button id="copyAll" type="button" class="copy-btn" title="Copy unique IP list" aria-label="Copy unique IP list">üìã Copy all IPs</button>
          <button id="downloadCsv" type="button" class="copy-btn" title="Download CSV for the consolidated list" aria-label="Download CSV for the consolidated list">‚¨áÔ∏è Download CSV</button>
        </div>
      </div>
      <div id="summary" class="small">No results yet.</div>

      <!-- Consolidated list -->
      <div id="consolidated" style="display:none; margin-top:8px;">
        <label for="all-ips">All unique IPs (one per line)</label>
        <textarea id="all-ips" readonly></textarea>
        <div class="small">Tip: Use the buttons above to copy or download this list.</div>
      </div>

      <!-- Individual cards -->
      <h3 id="cardsHeader" style="display:none; margin-top:18px;">Individual IP details</h3>
      <div id="list"></div>
    </div>

    <footer>
      Tip: If a site blocks cross-origin requests, paste the article HTML into the textarea and click <em>Extract from Pasted Text</em>.
    </footer>
  </div>

<script>
/* ===== Regex & normalization ===== */
const OCTET = '(?:25[0-5]|2[0-4]\\d|1?\\d?\\d)';
const SEP = `(?:\\s*(?:\\.|\\[\\s*\\.?\\s*\\]|\\(\\s*\\.?\\s*\\)|\\[\\s*dot\\s*\\]|\\(\\s*dot\\s*\\)|dot)\\s*)`;
const IPV4_RE = new RegExp(`\\b${OCTET}(?:${SEP}${OCTET}){3}\\b`, 'ig');
const RAW_SEP = '(?:\\.|\\[\\s*\\.?\\s*\\]|\\(\\s*\\.?\\s*\\)|\\[\\s*dot\\s*\\]|\\(\\s*dot\\s*\\)|dot|\\s*\\[\\s*\\]\\s*)';
const RAW_IP_CAND_RE = new RegExp(`\\b(\\d{1,3})(?:${RAW_SEP})(\\d{1,3})(?:${RAW_SEP})(\\d{1,3})(?:${RAW_SEP})(\\d{1,3})\\b`, 'ig');

function normalizeDefanged(text) {
  return text
    .replace(/\[\s*\.?\s*\]/gi, '.')
    .replace(/\(\s*\.?\s*\)/gi, '.')
    .replace(/\[\s*dot\s*\]/gi, '.')
    .replace(/\(\s*dot\s*\)/gi, '.')
    .replace(/\bdot\b/gi, '.')
    .replace(/ ?\uFF0E ?/g, '.');
}
function validIpFromParts(a,b,c,d) {
  const nums = [a,b,c,d].map(s => parseInt(s,10));
  if (nums.some(n => Number.isNaN(n))) return null;
  if (nums.every(n => n>=0 && n<=255)) return nums.join('.');
  return null;
}

/* ===== Text extraction ===== */
function extractVisibleText(html) {
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    doc.querySelectorAll('script, style, noscript, svg, header, footer, nav').forEach(n => n.remove());
    const root = doc.querySelector('article, main') || doc.body || doc.documentElement;
    const tmp = document.createElement('textarea');
    tmp.innerHTML = root.textContent || '';
    let text = tmp.value;
    text = text.replace(/\r\n/g, '\n').replace(/\u00A0/g, ' ');
    return text;
  } catch { return html; }
}

/* ===== Extraction pipeline ===== */
function extractIpsFromText(rawInput) {
  const lnText = String(rawInput ?? '').replace(/\r\n/g, '\n');
  const results = new Map();
  let m;

  while ((m = RAW_IP_CAND_RE.exec(lnText)) !== null) {
    const fullMatch = m[0];
    const start = Math.max(0, m.index - 80);
    const end = Math.min(lnText.length, m.index + fullMatch.length + 80);
    const context = lnText.slice(start, end).trim();

    const normalized = normalizeDefanged(fullMatch);
    const parts = normalized.split('.');
    if (parts.length !== 4) continue;
    const ip = validIpFromParts(parts[0], parts[1], parts[2], parts[3]);
    if (!ip) continue;

    if (!results.has(ip)) results.set(ip, { ip, count: 0, contexts: [] });
    const item = results.get(ip);
    item.count += 1;
    item.contexts.push({ rawMatch: fullMatch, contextText: context });
  }

  const visible = extractVisibleText(rawInput);
  const normalizedWhole = normalizeDefanged(visible);
  while ((m = IPV4_RE.exec(normalizedWhole)) !== null) {
    const ip = m[0];
    if (!results.has(ip)) results.set(ip, { ip, count: 0, contexts: [] });
    const item = results.get(ip);
    item.count += 1;
    const start = Math.max(0, m.index - 80);
    const end = Math.min(normalizedWhole.length, m.index + ip.length + 80);
    item.contexts.push({ rawMatch: ip, contextText: normalizedWhole.slice(start, end).trim() });
  }

  const arr = Array.from(results.values()).map(v => {
    const seen = new Set();
    v.contexts = v.contexts.filter(c => {
      if (seen.has(c.contextText)) return false;
      seen.add(c.contextText);
      return true;
    });
    return v;
  }).sort((a,b) => (b.count - a.count) || a.ip.localeCompare(b.ip));

  return arr;
}

/* ===== Fetch + fallback ===== */
const PROXIES = [
  (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  (url) => `https://cors.bridged.cc/${url}`
];
function looksLikeHttpUrl(s) {
  try { const u = new URL(s); return u.protocol === 'http:' || u.protocol === 'https:'; }
  catch { return false; }
}
async function fetchWithTimeout(resource, options = {}, ms = 12000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), ms);
  try { return await fetch(resource, { ...options, signal: controller.signal, redirect: 'follow' }); }
  finally { clearTimeout(id); }
}
async function fetchWithFallback(url, useProxies = true) {
  try {
    const r = await fetchWithTimeout(url, { method: 'GET' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return { text: await r.text(), source: 'direct' };
  } catch (err) {
    if (!useProxies) throw err;
    for (const makeProxy of PROXIES) {
      const purl = makeProxy(url);
      try {
        const r = await fetchWithTimeout(purl, { method: 'GET' }, 15000);
        if (!r.ok) throw new Error(`Proxy HTTP ${r.status}`);
        return { text: await r.text(), source: purl };
      } catch (err2) { console.warn('Proxy attempt failed:', err2); }
    }
    throw new Error('Fetch failed (direct + proxies).');
  }
}

/* ===== UI wiring ===== */
const urlInput = document.getElementById('url');
const fetchBtn = document.getElementById('fetchBtn');
const pasteBtn = document.getElementById('pasteBtn');
const manualText = document.getElementById('manualText');
const extractFromText = document.getElementById('extractFromText');
const clearBtn = document.getElementById('clearBtn');
const list = document.getElementById('list');
const summary = document.getElementById('summary');
const useProxiesCheckbox = document.getElementById('useProxies');
const copyAllBtn = document.getElementById('copyAll');
const downloadCsvBtn = document.getElementById('downloadCsv');

const consolidatedBox = document.getElementById('consolidated');
const allIpsTextarea = document.getElementById('all-ips');
const cardsHeader = document.getElementById('cardsHeader');

fetchBtn.addEventListener('click', async () => {
  const url = urlInput.value.trim();
  if (!url) { alert('Please paste an article URL (or paste the article HTML into the textarea).'); return; }
  if (!looksLikeHttpUrl(url)) { alert('Please enter a valid http(s) URL.'); return; }

  summary.textContent = 'Fetching‚Ä¶';
  list.innerHTML = '';
  consolidatedBox.style.display = 'none';
  cardsHeader.style.display = 'none';

  try {
    const useProxies = useProxiesCheckbox.checked;
    const res = await fetchWithFallback(url, useProxies);
    const ips = extractIpsFromText(res.text);
    displayResults(ips, url, res.source);
  } catch (err) {
    console.error(err);
    summary.textContent = 'Fetch failed: ' + (err.message || err);
    alert('Fetch failed. Try enabling CORS proxies (checkbox) or paste article HTML/text into the "Article HTML / Text" box and click "Extract from Pasted Text".');
  }
});

pasteBtn.addEventListener('click', () => manualText.focus());

extractFromText.addEventListener('click', () => {
  const text = manualText.value || '';
  if (!text.trim()) { alert('Paste article HTML or text into the textarea first.'); return; }
  list.innerHTML = '';
  consolidatedBox.style.display = 'none';
  cardsHeader.style.display = 'none';
  const ips = extractIpsFromText(text);
  displayResults(ips, '(pasted)', 'pasted');
});

clearBtn.addEventListener('click', () => {
  urlInput.value = '';
  manualText.value = '';
  list.innerHTML = '';
  allIpsTextarea.value = '';
  consolidatedBox.style.display = 'none';
  cardsHeader.style.display = 'none';
  summary.textContent = 'No results yet.';
});

/* ===== Results rendering ===== */
function displayResults(arr, sourceUrl, sourceLabel) {
  list.innerHTML = '';
  const src = sourceLabel || sourceUrl || 'unknown';

  if (!arr || arr.length === 0) {
    summary.textContent = `No IPs found (source: ${src}).`;
    consolidatedBox.style.display = 'none';
    cardsHeader.style.display = 'none';
    return;
  }

  // consolidated list
  const uniqueIps = arr.map(x => x.ip);
  allIpsTextarea.value = uniqueIps.join('\n');
  consolidatedBox.style.display = '';
  cardsHeader.style.display = '';

  summary.textContent = `${uniqueIps.length} unique IP(s) found (source: ${src}).`;

  // Cards
  arr.forEach(item => {
    const card = document.createElement('div');
    card.className = 'ipcard';

    const header = document.createElement('div');
    header.className = 'meta';
    const strong = document.createElement('strong');
    strong.textContent = item.ip;
    header.appendChild(strong);
    header.appendChild(document.createTextNode(` ‚Äî occurrences: ${item.count}`));
    card.appendChild(header);

    const controls = document.createElement('div');
    controls.style.marginTop = '8px';
    controls.className = 'small';

    // Marked, labeled buttons
    const copyBtn = document.createElement('button');
    copyBtn.type = 'button';
    copyBtn.textContent = 'üìã Copy IP';
    copyBtn.className = 'copy-btn';
    copyBtn.title = 'Copy this IP to clipboard';
    copyBtn.setAttribute('aria-label', `Copy ${item.ip} to clipboard`);
    copyBtn.addEventListener('click', () => navigator.clipboard.writeText(item.ip).catch(() => {}));

    const ipinfoBtn = document.createElement('button');
    ipinfoBtn.type = 'button';
    ipinfoBtn.textContent = 'üîé Open ipinfo.io';
    ipinfoBtn.className = 'copy-btn';
    ipinfoBtn.title = 'Open ipinfo.io for this IP';
    ipinfoBtn.setAttribute('aria-label', `Open ipinfo.io for ${item.ip}`);
    ipinfoBtn.addEventListener('click', () => window.open(`https://ipinfo.io/${item.ip}`, '_blank', 'noopener'));

    const arinBtn = document.createElement('button');
    arinBtn.type = 'button';
    arinBtn.textContent = 'üì° Open ARIN Whois';
    arinBtn.className = 'copy-btn';
    arinBtn.title = 'Open ARIN Whois for this IP';
    arinBtn.setAttribute('aria-label', `Open ARIN Whois for ${item.ip}`);
    arinBtn.addEventListener('click', () => window.open(`https://search.arin.net/rdap/?query=${item.ip}`, '_blank', 'noopener'));

    controls.appendChild(copyBtn);
    controls.appendChild(ipinfoBtn);
    controls.appendChild(arinBtn);
    card.appendChild(controls);

    // Contexts (up to 3)
    const maxCtx = Math.min(3, item.contexts.length);
    for (let i = 0; i < maxCtx; i++) {
      const c = item.contexts[i];
      const ctxDiv = document.createElement('div');
      ctxDiv.className = 'context';
      ctxDiv.innerHTML = highlightMatch(c.contextText, c.rawMatch);
      card.appendChild(ctxDiv);
    }

    list.appendChild(card);
  });
}

/* ===== Helpers ===== */
function escapeHtml(s) {
  return s.replace(/&/g, '&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function highlightMatch(contextText, rawMatch) {
  const escaped = escapeHtml(contextText);
  const normMatch = escapeHtml(normalizeDefanged(rawMatch));
  const rawEsc = escapeHtml(rawMatch);
  let idx = escaped.toLowerCase().indexOf(rawEsc.toLowerCase());
  if (idx >= 0) {
    return escaped.slice(0, idx) +
      '<mark style="background:#ffdede;padding:0 2px;border-radius:3px">' +
      escaped.slice(idx, idx + rawEsc.length) +
      '</mark>' + escaped.slice(idx + rawEsc.length);
  }
  idx = escaped.toLowerCase().indexOf(normMatch.toLowerCase());
  if (idx >= 0) {
    return escaped.slice(0, idx) +
      '<mark style="background:#ffdede;padding:0 2px;border-radius:3px">' +
      escaped.slice(idx, idx + normMatch.length) +
      '</mark>' + escaped.slice(idx + normMatch.length);
  }
  return escaped.replace(/(\d{1,3}(?:[.\[\]\(\)\s]*?(?:dot)?[.\[\]\(\)\s]*\d{1,3}){3})/i,
    '<mark style="background:#ffdede;padding:0 2px;border-radius:3px">$1</mark>');
}

/* ===== Consolidated list actions ===== */
copyAllBtn.addEventListener('click', async () => {
  const text = allIpsTextarea.value.trim();
  if (!text) { alert('No IPs to copy'); return; }
  try {
    await navigator.clipboard.writeText(text);
    alert('Copied IP list to clipboard.');
  } catch {
    alert('Clipboard failed. Here are the IPs:\n\n' + text);
  }
});

downloadCsvBtn.addEventListener('click', () => {
  const text = allIpsTextarea.value.trim();
  if (!text) { alert('No results to download'); return; }
  const rows = ['ip'];
  text.split('\n').forEach(ip => rows.push(`"${ip.replace(/"/g,'""')}"`));
  const csv = rows.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'ips.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
